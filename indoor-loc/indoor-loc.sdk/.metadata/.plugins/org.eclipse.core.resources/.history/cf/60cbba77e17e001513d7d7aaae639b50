/*
 * imu.c
 *
 *  Created on: Oct 28, 2015
 *      Author: rupprich
 */

//Includes
#include "imu.h"
#include "iic_utils.h"
#include <stdlib.h>
#include <unistd.h>
#include "xtime_l.h"

//Global Variables
XGpioPs Gpio; /* The driver instance for GPIO Device. */
XIicPs IicPs; /* The driver instance for IIC Device. */
static u8 imuAddr;
static char *imuAddr_cp;

//Function Prototypes
static int writeAD0(u32 *data);
static int readInt(u32 *DataRead);
static int setAddr(u8* addr, char* addr_c);

/*
 * IIC Write
 */
int imuI2cWrite(unsigned char slave_addr, unsigned char reg_addr,
		unsigned char length, unsigned char *data) {
	//Variables
	int status;

	//IIC Read
	status = iic_write2(&IicPs, slave_addr, reg_addr, *data);

	if (status != XST_SUCCESS) {
		xil_printf("IMU.c: Error on IIC Write.\r\n");
		return XST_FAILURE;
	}

	//Return
	return XST_SUCCESS;
}

/*
 * IIC Read
 */
int imuI2cRead(unsigned char slave_addr, unsigned char reg_addr,
		unsigned char length, unsigned char *data) {
	//Variables
	int status;

	//IIC Read
	status = iic_read2(&IicPs, slave_addr, reg_addr, data, length);

	if (status != XST_SUCCESS) {
		xil_printf("IMU.c: Error on IIC Read.\r\n");
		return XST_FAILURE;
	}

	//Return
	return XST_SUCCESS;
}

/*
 * Delay
 */
void imuDelay(unsigned long ms){
	usleep(ms*1000);
}

/*
 * Get Timestamp
 */
unsigned long imuGet_ms(){
	XTime time;
	XTime_getTime(&time);
	return time;
}

/*
 * Log I
 */
void imuLog_i(){
	//TODO
}

/*
 * Log I
 */
void imuLog_e(){
	//TODO
}

/*
 * Initialize IMU
 */
int imuInit() {
	//Variables
	int status;
	imuAddr_cp = (char *) malloc(8);

	//Init IIC
	status = iic_init(&IicPs, IIC_DEVICE_ID, IIC_SCLK_RATE);
	if (status != XST_SUCCESS) {
		xil_printf("IMU.c: Error initializing IIC.\r\n");
		return XST_FAILURE;
	}

	//Set IMU Address
	status = setAddr(&imuAddr, imuAddr_cp);
	if (status != XST_SUCCESS) {
		xil_printf("IMU.c: Error setting IMU address.\r\n");
		return XST_FAILURE;
	}

	//Return
	return XST_SUCCESS;
}

/*
 * Set IMU Address
 */
int setAddr(u8* addr, char* addr_c) {
	//1. Initialize GPIO
	int status;
	u32 addr_last_bit = IMU_LAST_ADDR_BIT;
	XGpioPs_Config *ConfigPtr;

	/* Initialize the GPIO driver. */
	ConfigPtr = XGpioPs_LookupConfig(GPIO_DEVICE_ID);
	status = XGpioPs_CfgInitialize(&Gpio, ConfigPtr, ConfigPtr->BaseAddr);
	if (status != XST_SUCCESS) {
		xil_printf("IMU.c: Error initializing GPIO Config.\r\n");
		return XST_FAILURE;
	}

	//2. Set ad0
	status = writeAD0(&addr_last_bit);
	if (status != XST_SUCCESS) {
		xil_printf("IMU.c: Error setting AD0 for IMU.\r\n");
		return XST_FAILURE;
	}

	//3. Set IMU address
	*addr = IMU_ADDR_MASK & IMU_LAST_ADDR_BIT;
	sprintf(imuAddr_cp, "%d", *addr);

	//Return
	return XST_SUCCESS;
}

/*
 * Write to Pin
 */
int writeAD0(u32 *data) {

	/*
	 * Set the direction for the pin to be output and
	 * Enable the Output enable for the LED Pin.
	 */
	XGpioPs_SetDirectionPin(&Gpio, PS_IMU_AD0_PIN, 1);
	XGpioPs_SetOutputEnablePin(&Gpio, PS_IMU_AD0_PIN, 1);

	/* Set the GPIO output to be low. */
	XGpioPs_WritePin(&Gpio, PS_IMU_AD0_PIN, *data);

	return XST_SUCCESS;
}

/*
 * Get Interrupt
 */
int readInt(u32 *DataRead) {

	/* Set the direction for the specified pin to be input. */
	XGpioPs_SetDirectionPin(&Gpio, PS_IMU_INT_PIN, 0x0);

	/* Read the state of the data so that it can be  verified. */
	*DataRead = XGpioPs_ReadPin(&Gpio, PS_IMU_INT_PIN);

	return XST_SUCCESS;
}
